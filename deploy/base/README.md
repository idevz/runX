# base pvm 无法做到自动化

*因为 Parallels Tools 必须登录到 pvm 中 手动进行安装*

*Unable to open new session in this virtual machine.
Make sure the latest version of Parallels Tools is installed 
in this virtual machine and it has finished booting.*

# 部署多内核 base

* 先通网 （prl_ctl 窗口操作）
* scp 推送内核代码到 `/usr/src/kernel/` 目录 `scp $RUNX_PKGS/linux-4.9.93.tar.xz z@$10.211.55.160:/usr/src/kernel`
* ssh 登录 pvm，编译安装内核

# base pvm 手动部署流程

* 默认为无网环境，先手动配置 eth0，拨通网络
* ssh 登录，安装 Parallels Tools
* 然后安装 Parallels Tools 为远程管理提供基础（先挂载，然后安装依赖包）
* 设置语言和位置环境变量，启动 sshd 服务，初始化 `~/.ssh` 目录
* 挂载共享目录（runX，code）
* 设置 sshd，部署免密登录
* 进程初步环境初始化操作 init_etc，安装相关工具包等（执行 init 脚本 自动安装）
  
## eth0 配置 (/etc/sysconfig/network-scripts/ifcfg-eth0)

```conf
# Generated by parse-kickstart
DEVICE="eth0"
IPV6INIT="yes"
BOOTPROTO="static"
ONBOOT="yes"
IPADDR="10.211.55.100"
NETMASK="255.255.255.0"
GATEWAY="10.211.55.1"
```

* sudo ifdown eth0 && sudo ifup eth0

## 安装 Parallels Tools

```bash
pre_install_parallels_tools() {
	sudo yum -y install https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm dkms \
		ftp://ftp.riken.jp/Linux/cern/centos/7/updates/x86_64/Packages/kernel-devel-3.10.0-693.el7.x86_64.rpm
}

pre_install_parallels_tools_el8() {
	sudo yum -y install https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm \
	rpm-build

	curl -fSL https://linux.itecs.ncsu.edu/redhat/ncsu/rhel8-beta-needed/8/SRPMS/dkms-2.6.1-1.el8.src.rpm -o dkms-2.6.1-1.el8.src.rpm
	rpmbuild --rebuild --clean dkms-2.6.1-1.el8.src.rpm
	sudo yum install -y /home/z/rpmbuild/RPMS/noarch/dkms-2.6.1-1.el8.noarch.rpm
}

cat > /etc/sysconfig/network-scripts/ifcfg-eth0 <<EOF
NAME=eth0
DEVICE=eth0
ONBOOT=yes
BOOTPROTO=none
TYPE=Ethernet
IPADDR=10.211.55.180
NETMASK=255.255.255.0
GATEWAY=10.211.55.1
EOF

# install_parallels_tools manual install
install_parallels_tools() {
	pre_install_parallels_tools
	[ ! -d /media/cdrom ] && sudo mkdir /media/cdrom
	sudo mount | grep iso9660
	sudo umount /dev/cdrom \
		mount -o exec /dev/cdrom /media/cdrom \
		cd /media/cdrom/ \
		./install
}
```

## 语言环境 (vi /etc/environment)

```bash
LANG=en_US.utf-8
LC_ALL=en_US.utf-8
```